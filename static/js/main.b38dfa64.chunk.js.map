{"version":3,"sources":["calc.js","kml.js","useSavedState.js","geoJSON.js","Tier.js","Plural.js","TierControls.js","App.js","index.js"],"names":["filterPlaces","places","minLimit","maxLimit","Infinity","filter","place","tags","population","prepareConnectors","maxVertexLength","narrowAngleLimit","excludedConnectors","connectors","makeConnectors","narrowAngleOptimise","length","connectorsExcept","exclude","out","p1","p2","id","dist","calculateDistance","includesPair","push","place1","place2","list","a","b","alpha","beta","minAngle","sort","connectorLengthComparator","outList","item","includeLine","other","joinedLines","joinLines","angle","calculateAngle","φ1","lat","Math","PI","φ2","Δφ","Δλ","lon","sin","cos","atan2","sqrt","lineA","lineB","bearingA","calculateBearing","bearingB","delta","abs","point1","point2","X","Y","except","c","find","e","segmentA","segmentB","generateKML","layers","map","layer","label","points","p","point","style","name","join","lines","l","toFixed","generateLineStringPlacemark","generateFolder","useSavedState","key","defaultValue","tabSync","useState","savedValue","localStorage","getItem","JSON","parse","Function","state","setState","useEffect","cb","newValue","window","addEventListener","removeEventListener","updateValue","useCallback","setItem","stringify","tierColours","createGeoJSON","Tier","tier","placesGeoJSON","connectorsGeoJSON","circlePaint","createCirclePaint","linePaint","createLinePaint","data","Plural","n","singular","plural","TierControls","showNodes","setShowNodes","showVertices","setShowVertices","setMaxVertexLength","type","checked","onChange","target","min","value","valueAsNumber","Map","ReactMapboxGl","accessToken","centreZoom","saved","getLocalStorageJSON","initialCentre","slice","initialZoom","App","setPlaces","mapRef","useRef","loadOnScroll","setLoadOnScroll","loading","setLoading","error","setError","mapLoaded","setMapLoaded","showT1Nodes","setShowT1Nodes","showT1Vertices","setShowT1Vertices","maxT1VertexLength","setMaxT1VertexLength","showT2Nodes","setShowT2Nodes","showT2Vertices","setShowT2Vertices","maxT2VertexLength","setMaxT2VertexLength","showT3Nodes","setShowT3Nodes","showT3Vertices","setShowT3Vertices","maxT3VertexLength","setMaxT3VertexLength","showT4Nodes","setShowT4Nodes","showT4Vertices","setShowT4Vertices","maxT4VertexLength","setMaxT4VertexLength","setNarrowAngleLimit","debounced","callback","timeout","readyRef","current","setTimeout","useDebouncedCallback","loadData","bounds","bbox","url","hit","cache","h","result","fetch","then","r","ok","json","status","Promise","reject","unshift","cachedFetch","fetchPlaces","getBounds","toArray","flat","d","elements","havePlaces","centre","getCenter","zoom","getZoom","on","off","placesT1","connectorsT1","placesT2","cumlPlacesT2","connectorsT2","placesT3","cumlPlacesT3","excludeConnectionsT3","connectorsT3","placesT4","cumlPlacesT4","excludeConnectionsT4","connectorsT4","className","color","toString","onClick","max","filename","blob","Blob","URL","createObjectURL","document","createElement","href","download","body","append","click","removeChild","revokeObjectURL","downloadFile","containerStyle","height","width","onSourceData","center","ReactDOM","render","StrictMode","getElementById"],"mappings":"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","file":"static/js/main.b38dfa64.chunk.js","sourcesContent":["/**\r\n * @typedef {import('./geoJSON').OverpassElement} OverpassElement\r\n */\r\n\r\n/**\r\n * @typedef {{lat: number;lon: number;}} BasicPoint\r\n */\r\n\r\n/**\r\n * @typedef {[BasicPoint, BasicPoint]} BasicLine\r\n */\r\n\r\n\r\n/**\r\n * @param {OverpassElement[]} places\r\n * @param {number} [minLimit]\r\n * @param {number} [maxLimit]\r\n */\r\nexport function filterPlaces(places, minLimit = 0, maxLimit = Infinity) {\r\n    return places.filter(place => minLimit <= +place.tags.population && +place.tags.population < maxLimit);\r\n}\r\n\r\n/**\r\n * @param {OverpassElement[]} places\r\n * @param {number} maxVertexLength\r\n * @param {number} narrowAngleLimit\r\n * @param {[OverpassElement,OverpassElement][]} excludedConnectors\r\n */\r\nexport function prepareConnectors (places, maxVertexLength, narrowAngleLimit, excludedConnectors = []) {\r\n  let connectors = makeConnectors(places, maxVertexLength);\r\n\r\n  if (narrowAngleLimit > 0) {\r\n    connectors = narrowAngleOptimise(connectors, narrowAngleLimit);\r\n  }\r\n\r\n  if (excludedConnectors.length > 0) {\r\n    connectors = connectorsExcept(connectors, excludedConnectors);\r\n  }\r\n\r\n  return connectors;\r\n}\r\n\r\n/**\r\n * @param {OverpassElement[]} places\r\n * @param {number} maxVertexLength\r\n * @param {[OverpassElement, OverpassElement][]} [exclude]\r\n */\r\n\r\nexport function makeConnectors(places, maxVertexLength, exclude = []) {\r\n  /** @type {[OverpassElement, OverpassElement][]} */\r\n  const out = [];\r\n\r\n  for (const p1 of places) {\r\n    for (const p2 of places) {\r\n      if (p1.id < p2.id) {\r\n        const dist = calculateDistance(p1, p2);\r\n\r\n        if (dist < maxVertexLength && !includesPair(p1, p2, exclude)) {\r\n          out.push([p1, p2]);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  return out;\r\n}\r\n\r\n/**\r\n * @param {OverpassElement} place1\r\n * @param {OverpassElement} place2\r\n * @param {[OverpassElement, OverpassElement][]} list\r\n */\r\nfunction includesPair(place1, place2, list) {\r\n  const a = place1.id < place2.id ? place1 : place2;\r\n  const b = place1.id < place2.id ? place2 : place1;\r\n\r\n  for (const [alpha, beta] of list) {\r\n    if (a === alpha && b === beta)\r\n      return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n/**\r\n *\r\n * @template T\r\n * @param {(T & BasicLine)[]} connectors\r\n * @param {number} minAngle in degrees\r\n * @returns {T[]}\r\n */\r\nexport function narrowAngleOptimise (connectors, minAngle = 1) {\r\n  if (minAngle <= 0) {\r\n    return connectors;\r\n  }\r\n\r\n  connectors.sort(connectorLengthComparator);\r\n\r\n  const outList = [];\r\n\r\n  for (const item of connectors) {\r\n    let includeLine = true;\r\n\r\n    for (const other of outList) {\r\n      // Try to join the lines to make sure the lines are connected and the points are in the correct order.\r\n      //\r\n      // e.g if the lines are [C -> B] and [A -> C] then this function will return [B -> C -> A]\r\n      const joinedLines = joinLines(item, other);\r\n\r\n      if (joinedLines) {\r\n        // If the points are B -> C -> A\r\n        // then the angle will be calculated between [C -> B] and [C -> A]\r\n        const angle = calculateAngle([joinedLines[1],joinedLines[0]], [joinedLines[1], joinedLines[2]]);\r\n\r\n        if (angle < minAngle) {\r\n          includeLine = false;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (includeLine) {\r\n      outList.push(item);\r\n    }\r\n  }\r\n\r\n  return outList;\r\n}\r\n\r\n/**\r\n * @param {BasicLine} a\r\n * @param {BasicLine} b\r\n */\r\nfunction connectorLengthComparator (a, b) {\r\n  const distA = calculateDistance(a[0], a[1]);\r\n  const distB = calculateDistance(b[0], b[1]);\r\n\r\n  return distA - distB;\r\n}\r\n\r\n/**\r\n *\r\n * @param {BasicPoint} p1\r\n * @param {BasicPoint} p2\r\n */\r\n export function calculateDistance(p1, p2) {\r\n  const R = 6371e3; // metres\r\n  const φ1 = p1.lat * Math.PI / 180; // φ, λ in radians\r\n  const φ2 = p2.lat * Math.PI / 180;\r\n  const Δφ = (p2.lat - p1.lat) * Math.PI / 180;\r\n  const Δλ = (p2.lon - p1.lon) * Math.PI / 180;\r\n\r\n  const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +\r\n    Math.cos(φ1) * Math.cos(φ2) *\r\n    Math.sin(Δλ / 2) * Math.sin(Δλ / 2);\r\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\r\n\r\n  return R * c; // in metres\r\n}\r\n\r\n/**\r\n *\r\n * @param {BasicLine} lineA\r\n * @param {BasicLine} lineB\r\n */\r\nfunction calculateAngle(lineA, lineB) {\r\n  const bearingA = calculateBearing(lineA[0], lineA[1]);\r\n  const bearingB = calculateBearing(lineB[0], lineB[1]);\r\n\r\n  let delta = Math.abs(bearingB - bearingA);\r\n  const smallAngle = delta > 180 ? (180 - (delta - 180)) : delta;\r\n\r\n  return smallAngle;\r\n}\r\n\r\n\r\n/**\r\n *\r\n * @param {BasicPoint} point1\r\n * @param {BasicPoint} point2\r\n * @returns {number} Bearing in degrees\r\n */\r\nfunction calculateBearing (point1, point2) {\r\n  const φ1 = point1.lat * Math.PI / 180; // φ, λ in radians\r\n  const φ2 = point2.lat * Math.PI / 180;\r\n  const Δλ = (point2.lon - point1.lon) * Math.PI / 180;\r\n\r\n  const X = Math.cos(φ2) * Math.sin(Δλ);\r\n  const Y = Math.cos(φ1) * Math.sin(φ2) - Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);\r\n\r\n  return Math.atan2(Y, X) * 180 / Math.PI;\r\n}\r\n\r\n/**\r\n * Assumes connectors all follow convention of lower id first\r\n * @template T\r\n * @param {(T & BasicLine)[]} connectors\r\n * @param {(T & BasicLine)[]} except\r\n * @returns {T[]}\r\n */\r\nexport function connectorsExcept (connectors, except) {\r\n  return connectors.filter(c => typeof except.find(e => c[0] === e[0] && c[1] === e[1]) === \"undefined\");\r\n}\r\n\r\n/**\r\n * Finds the common node of two line segments then returns a three point line if it finds one.\r\n * Returns undefined if the two lines are not connected.\r\n * @param {BasicLine} segmentA\r\n * @param {BasicLine} segmentB\r\n * @returns {[BasicPoint, BasicPoint, BasicPoint]}\r\n */\r\nfunction joinLines (segmentA, segmentB) {\r\n  if (segmentA[0] === segmentB[0]) {\r\n    return [segmentA[1], segmentA[0], segmentB[1]];\r\n  }\r\n  if (segmentA[0] === segmentB[1]) {\r\n    return [segmentA[1], segmentA[0], segmentB[0]];\r\n  }\r\n  if (segmentA[1] === segmentB[0]) {\r\n    return [segmentA[0], segmentA[1], segmentB[1]];\r\n  }\r\n  if (segmentA[1] === segmentB[1]) {\r\n    return [segmentA[0], segmentA[1], segmentB[0]];\r\n  }\r\n}","import { calculateDistance } from \"./calc\";\r\n\r\n/**\r\n * @typedef {import(\"./geoJSON\").OverpassElement} OverpassElement\r\n */\r\n\r\nexport function generateKML (layers) {\r\n    return `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<kml xmlns=\"http://www.opengis.net/kml/2.2\">\r\n    <Document>\r\n        <Style id=\"tier1_places\">\r\n            <IconStyle>\r\n                <color>ffffff00</color>\r\n                <scale>2</scale>\r\n                <Icon>\r\n                    <href>http://maps.google.com/mapfiles/kml/paddle/wht-blank.png</href>\r\n                </Icon>\r\n                <hotSpot x=\"32\" y=\"1\" xunits=\"pixels\" yunits=\"pixels\"/>\r\n            </IconStyle>\r\n        </Style>\r\n        <Style id=\"tier2_places\">\r\n            <IconStyle>\r\n                <color>ffcf9a02</color>\r\n                <scale>1.6666</scale>\r\n                <Icon>\r\n                    <href>http://maps.google.com/mapfiles/kml/paddle/wht-blank.png</href>\r\n                </Icon>\r\n                <hotSpot x=\"32\" y=\"1\" xunits=\"pixels\" yunits=\"pixels\"/>\r\n            </IconStyle>\r\n        </Style>\r\n        <Style id=\"tier3_places\">\r\n            <IconStyle>\r\n                <color>ffff7f00</color>\r\n                <scale>1.25</scale>\r\n                <Icon>\r\n                    <href>http://maps.google.com/mapfiles/kml/paddle/wht-blank.png</href>\r\n                </Icon>\r\n                <hotSpot x=\"32\" y=\"1\" xunits=\"pixels\" yunits=\"pixels\"/>\r\n            </IconStyle>\r\n        </Style>\r\n        <Style id=\"tier4_places\">\r\n            <IconStyle>\r\n                <color>ffcc0000</color>\r\n                <scale>1</scale>\r\n                <Icon>\r\n                    <href>http://maps.google.com/mapfiles/kml/paddle/wht-blank.png</href>\r\n                </Icon>\r\n                <hotSpot x=\"32\" y=\"1\" xunits=\"pixels\" yunits=\"pixels\"/>\r\n            </IconStyle>\r\n        </Style>\r\n        <Style id=\"tier1_connectors\">\r\n            <LineStyle>\r\n                <color>ffffff00</color>\r\n                <width>5</width>\r\n            </LineStyle>\r\n        </Style>\r\n        <Style id=\"tier2_connectors\">\r\n            <LineStyle>\r\n                <color>ffcf9a02</color>\r\n                <width>4</width>\r\n            </LineStyle>\r\n        </Style>\r\n        <Style id=\"tier3_connectors\">\r\n            <LineStyle>\r\n                <color>ffff7f00</color>\r\n                <width>3</width>\r\n            </LineStyle>\r\n        </Style>\r\n        <Style id=\"tier4_connectors\">\r\n            <LineStyle>\r\n                <color>ffcc0000</color>\r\n                <width>2</width>\r\n            </LineStyle>\r\n        </Style>\r\n        ${layers.map(layer => generateFolder(layer)).join(\"\")}\r\n    </Document>\r\n</kml>`;\r\n}\r\n\r\n/**\r\n *\r\n * @param {{\r\n *  label: string,\r\n *  points?: OverpassElement[],\r\n *  lines?: [OverpassElement, OverpassElement][],\r\n *  style: string\r\n * }} layer\r\n */\r\nfunction generateFolder (layer) {\r\n    return `\r\n    <Folder>\r\n        <name>${layer.label}</name>\r\n        ${layer.points ? layer.points.map(p => generatePointPlacemark(p, layer.style)).join(\"\") : \"\"}\r\n        ${layer.lines ? layer.lines.map(l => generateLineStringPlacemark(l, layer.style)).join(\"\") : \"\"}\r\n    </Folder>`;\r\n}\r\n\r\n/**\r\n * @param {OverpassElement} point\r\n */\r\nfunction generatePointPlacemark (point, style) {\r\n    return `\r\n        <Placemark>\r\n            <name>${point.tags.name}</name>\r\n            <description>Population: ${point.tags.population}</description>\r\n            <styleUrl>#${style}</styleUrl>\r\n            <Point>\r\n                <coordinates>${point.lon},${point.lat},0</coordinates>\r\n            </Point>\r\n        </Placemark>`;\r\n}\r\n\r\n/**\r\n * @param {[OverpassElement, OverpassElement]} line\r\n * @param {string} style\r\n */\r\nfunction generateLineStringPlacemark ([ p1, p2 ], style) {\r\n    return `\r\n        <Placemark>\r\n            <name>From ${p1.tags.name} to ${p2.tags.name}</name>\r\n            <description>Distance: ${calculateDistance(p1, p2).toFixed(0)}m</description>\r\n            <styleUrl>#${style}</styleUrl>\r\n            <LineString>\r\n                <coordinates>\r\n                    ${p1.lon},${p1.lat},0\r\n                    ${p2.lon},${p2.lat},0\r\n                </coordinates>\r\n            </LineString>\r\n        </Placemark>`;\r\n}","import { useCallback, useEffect, useState } from \"react\";\r\n\r\n/**\r\n *\r\n * @template T\r\n * @param {string} key\r\n * @param {T|(() => T)} defaultValue\r\n * @param {boolean} [tabSync] Keep all open tabs in sync\r\n * @returns {[T, (newValue: T) => void]}\r\n */\r\nexport default function useSavedState (key, defaultValue, tabSync = true) {\r\n    const [ state, setState ] = useState(() => {\r\n        const savedValue = localStorage.getItem(key);\r\n\r\n        if (savedValue) {\r\n            try {\r\n                return JSON.parse(savedValue);\r\n            } catch (e) {}\r\n        }\r\n\r\n        if (defaultValue instanceof Function) {\r\n            return defaultValue();\r\n        }\r\n\r\n        return defaultValue;\r\n    });\r\n\r\n    useEffect(() => {\r\n        if (tabSync) {\r\n            const cb = (/** @type {StorageEvent} */ e) => {\r\n                if (e.key === key) {\r\n                    try {\r\n                        setState(JSON.parse(e.newValue));\r\n                    } catch (e) {}\r\n                }\r\n            };\r\n\r\n            window.addEventListener(\"storage\", cb);\r\n\r\n            return () => window.removeEventListener(\"storage\", cb);\r\n        }\r\n    }, [key, tabSync]);\r\n\r\n    const updateValue = useCallback((newValue) => {\r\n        setState(newValue);\r\n\r\n        localStorage.setItem(key, JSON.stringify(newValue));\r\n    }, [setState, key]);\r\n\r\n    return [\r\n        state,\r\n        updateValue,\r\n    ];\r\n}","\r\nconst tierColours = ['#00FFFF', '#029ACF', '#007FFF', '#0000CC'];\r\nexport function createCirclePaint(tier) {\r\n  return {\r\n    'circle-radius': {\r\n      'base': 5 / tier,\r\n      'stops': [\r\n        [12, 10 / tier],\r\n        [22, 180 / tier]\r\n      ]\r\n    },\r\n    // color circles by ethnicity, using a match expression\r\n    // https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-match\r\n    'circle-color': tierColours[tier - 1],\r\n  };\r\n}\r\nexport function createLinePaint(tier) {\r\n  return {\r\n    'line-width': {\r\n      'base': 3 / tier,\r\n      'stops': [\r\n        [12, 5 / tier],\r\n        [22, 90 / tier]\r\n      ]\r\n    },\r\n    // color circles by ethnicity, using a match expression\r\n    // https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-match\r\n    'line-color': tierColours[tier - 1],\r\n  };\r\n}\r\n/**\r\n * @typedef OverpassElement\r\n * @property {number} id\r\n * @property {number} lat\r\n * @property {number} lon\r\n * @property {\"node\"|\"way\"|\"relation\"} type\r\n * @property {{ [key: string]: string }} tags\r\n */\r\n/**\r\n *\r\n * @param {OverpassElement[]} places\r\n * @param {OverpassElement[][]} connectors\r\n * @returns\r\n */\r\nexport function createGeoJSON(places, connectors) {\r\n  return {\r\n    \"type\": \"FeatureCollection\",\r\n    \"features\": [\r\n      ...places.map(place => ({\r\n        \"geometry\": {\r\n          \"type\": \"Point\",\r\n          \"coordinates\": [place.lon, place.lat]\r\n        },\r\n        \"properties\": {\r\n          \"name\": place.tags.name\r\n        }\r\n      })),\r\n      ...connectors.map(([p1, p2]) => ({\r\n        \"geometry\": {\r\n          \"type\": \"LineString\",\r\n          \"coordinates\": [\r\n            [p1.lon, p1.lat],\r\n            [p2.lon, p2.lat],\r\n          ]\r\n        },\r\n        \"properties\": {\r\n          \"name\": `From ${p1.tags.name} to ${p2.tags.name}`\r\n        }\r\n      })),\r\n    ]\r\n  };\r\n}\r\n\r\n","import React from \"react\";\r\nimport { GeoJSONLayer } from \"react-mapbox-gl\";\r\nimport { createCirclePaint, createGeoJSON, createLinePaint } from \"./geoJSON\";\r\n\r\nexport function Tier ({ places = [], connectors = [], tier }) {\r\n    const placesGeoJSON = createGeoJSON(places, []);\r\n    const connectorsGeoJSON = createGeoJSON([], connectors);\r\n    const circlePaint = createCirclePaint(tier);\r\n    const linePaint = createLinePaint(tier);\r\n\r\n    return <>\r\n        <GeoJSONLayer data={placesGeoJSON} circlePaint={circlePaint} />\r\n        <GeoJSONLayer data={connectorsGeoJSON} linePaint={linePaint} />\r\n    </>;\r\n}","export function Plural({ n, singular, plural = null }) {\r\n  return <>{`${n} ${n === 1 ? singular : (plural || singular + 's')}`}</>;\r\n}\r\n","import React from \"react\";\r\nimport { Plural } from \"./Plural\";\r\n\r\nexport function TierControls ({ label, places, connectors, showNodes, setShowNodes, showVertices, setShowVertices, maxVertexLength, setMaxVertexLength }) {\r\n    return <>\r\n        <h2>{ label }</h2>\r\n        <label>\r\n          <input type=\"checkbox\" checked={showNodes} onChange={e => setShowNodes(e.target.checked)} />\r\n          <Plural n={places.length} singular=\"Place\" />\r\n        </label>\r\n        <label>\r\n          <input type=\"checkbox\" checked={showVertices} onChange={e => setShowVertices(e.target.checked)} />\r\n          <Plural n={connectors.length} singular=\"Connection\" />\r\n        </label>\r\n        <label>\r\n          Max Connection Length (km)\r\n          <input type=\"number\" min={0} value={maxVertexLength / 1000} onChange={e => setMaxVertexLength(e.target.valueAsNumber * 1000)} />\r\n        </label>\r\n    </>;\r\n}","import './App.css';\nimport ReactMapboxGl, { ZoomControl, ScaleControl } from 'react-mapbox-gl';\nimport 'mapbox-gl/dist/mapbox-gl.css';\nimport React, { useCallback, useEffect, useRef, useState } from 'react';\nimport { generateKML } from './kml';\nimport { filterPlaces, prepareConnectors } from \"./calc\";\nimport useSavedState from './useSavedState';\nimport { Tier } from './Tier';\nimport { Plural } from './Plural';\nimport { TierControls } from './TierControls';\n\nconst Map = ReactMapboxGl({\n  accessToken:\n    'pk.eyJ1IjoiaWptYWNkIiwiYSI6ImNqZ2J6dnNvYjM5Y3QzMnFkYWNybzM2bnkifQ.OE6IZdjeV6XK-NGACNu60g'\n});\n\nconst centreZoom = getLocalStorageJSON(\"POPMESH_CENTRE_ZOOM\");\n\n/** @type {[number,number]} */\nconst initialCentre = centreZoom ? centreZoom.slice(0,2) : [-3.667,56.66];\n/** @type {[number]} */\nconst initialZoom = centreZoom ? centreZoom.slice(2) : [7];\n\nconst excludeHigherTiers = true;\n\nfunction App() {\n  const [ places, setPlaces ] = useState([]);\n  /** @type {import('react').MutableRefObject<import('mapbox-gl').Map>} */\n  const mapRef = useRef(null);\n\n  const [ loadOnScroll, setLoadOnScroll ] = useSavedState(\"POPMESH_LOAD_ON_SCROLL\", false);\n  const [ loading, setLoading ] = useState(false);\n  const [ error, setError ] = useState(null);\n  const [ mapLoaded, setMapLoaded ] = useState(false);\n\n  const [ showT1Nodes, setShowT1Nodes ] = useSavedState(\"POPMESH_NODES_T1\", true, false);\n  const [ showT1Vertices, setShowT1Vertices ] = useSavedState(\"POPMESH_VERTICES_T1\", true, false);\n  const [ maxT1VertexLength, setMaxT1VertexLength ] = useSavedState(\"POPMESH_VERTEX_LENGTH_T1\", 105000, false);\n\n  const [ showT2Nodes, setShowT2Nodes ] = useSavedState(\"POPMESH_NODES_T2\", true, false);\n  const [ showT2Vertices, setShowT2Vertices ] = useSavedState(\"POPMESH_VERTICES_T2\", true, false);\n  const [ maxT2VertexLength, setMaxT2VertexLength ] = useSavedState(\"POPMESH_VERTEX_LENGTH_T2\", 100000, false);\n\n  const [ showT3Nodes, setShowT3Nodes ] = useSavedState(\"POPMESH_NODES_T3\", true, false);\n  const [ showT3Vertices, setShowT3Vertices ] = useSavedState(\"POPMESH_VERTICES_T3\", true, false);\n  const [ maxT3VertexLength, setMaxT3VertexLength ] = useSavedState(\"POPMESH_VERTEX_LENGTH_T3\", 95000, false);\n\n  const [ showT4Nodes, setShowT4Nodes ] = useSavedState(\"POPMESH_NODES_T4\", true, false);\n  const [ showT4Vertices, setShowT4Vertices ] = useSavedState(\"POPMESH_VERTICES_T4\", false, false);\n  const [ maxT4VertexLength, setMaxT4VertexLength ] = useSavedState(\"POPMESH_VERTEX_LENGTH_T4\", 90000, false);\n\n  const [ narrowAngleLimit, setNarrowAngleLimit ] = useSavedState(\"POPMESH_NARROW_ANGLE\", 20, false);\n\n  const debounced = useDebouncedCallback(loadData, 5000);\n\n  function loadData () {\n    if (mapRef.current) {\n      fetchPlaces(mapRef.current.getBounds().toArray().flat())\n        .then(d => {\n          setPlaces(d.elements);\n          setError(null);\n        }, setError)\n        .then(() => setLoading(false));\n      setLoading(true);\n    }\n  }\n\n  const havePlaces = places.length > 0;\n\n  // Need to add callback manually because react-mapbox-gl retains\n  // callback from first render.\n  useEffect(() => {\n    function cb () {\n      if (loadOnScroll || !havePlaces) {\n        debounced();\n      }\n\n      // Use this opportunity to save centre/zoom info\n      const centre = mapRef.current.getCenter().toArray();\n      const zoom = mapRef.current.getZoom();\n      localStorage.setItem(\"POPMESH_CENTRE_ZOOM\", JSON.stringify([ ...centre, zoom]))\n    }\n\n    if (mapRef.current) {\n      mapRef.current.on(\"sourcedata\", cb);\n\n      return () => {\n        mapRef.current.off(\"sourcedata\", cb);\n      };\n    }\n  }, [debounced, loadOnScroll, havePlaces, mapLoaded]);\n\n  function handleSourceData (map) {\n    if (!mapRef.current) {\n      setMapLoaded(true);\n    }\n\n    mapRef.current = map;\n  }\n\n  const placesT1 = filterPlaces(places, 100000);\n  let connectorsT1 = showT1Vertices ? prepareConnectors(placesT1, maxT1VertexLength, narrowAngleLimit) : [];\n\n  const placesT2 = filterPlaces(places, 50000, 100000);\n  const cumlPlacesT2 = [...placesT1, ...placesT2];\n  const excludeConnectionsT2 = excludeHigherTiers ? connectorsT1 : [];\n  let connectorsT2 = showT2Vertices ? prepareConnectors(cumlPlacesT2, maxT2VertexLength, narrowAngleLimit, excludeConnectionsT2) : [];\n\n  const placesT3 = filterPlaces(places, 10000, 50000);\n  const cumlPlacesT3 = [...placesT1, ...placesT2, ...placesT3];\n  const excludeConnectionsT3 = excludeHigherTiers ? [...connectorsT1, ...connectorsT2] : [];\n  let connectorsT3 = showT3Vertices ? prepareConnectors(cumlPlacesT3, maxT3VertexLength, narrowAngleLimit, excludeConnectionsT3) : [];\n\n  const placesT4 = filterPlaces(places, 5000, 10000);\n  const cumlPlacesT4 = [...placesT1, ...placesT2, ...placesT3, ...placesT4];\n  const excludeConnectionsT4 = excludeHigherTiers ? [...connectorsT1, ...connectorsT2, ...connectorsT3] : [];\n  let connectorsT4 = showT4Vertices ? prepareConnectors(cumlPlacesT4, maxT4VertexLength, narrowAngleLimit, excludeConnectionsT4) : [];\n\n  function handleDownload () {\n    const layers = [];\n\n    if (showT1Nodes) layers.push({ label: \"100k+\",      points: placesT1, style: \"tier1_places\" });\n    if (showT2Nodes) layers.push({ label: \"50k - 100k\", points: placesT2, style: \"tier2_places\" });\n    if (showT3Nodes) layers.push({ label: \"10k - 50k\",  points: placesT3, style: \"tier3_places\" });\n    if (showT4Nodes) layers.push({ label: \"5k - 10k\",   points: placesT4, style: \"tier4_places\" });\n\n    if (showT1Vertices) layers.push({ label: \"Connections 100k+\",      lines: connectorsT1, style: \"tier1_connectors\" });\n    if (showT2Vertices) layers.push({ label: \"Connections 50k - 100k\", lines: connectorsT2, style: \"tier2_connectors\" });\n    if (showT3Vertices) layers.push({ label: \"Connections 10k - 50k\",  lines: connectorsT3, style: \"tier3_connectors\" });\n    if (showT4Vertices) layers.push({ label: \"Connections 5k - 10k\",   lines: connectorsT4, style: \"tier4_connectors\" });\n\n    const kml = generateKML(layers);\n\n    downloadFile(\"places.kml\", kml);\n  }\n\n  return (\n    <div className=\"App\">\n      <div className=\"Panel\">\n        { error ?\n          <p style={{ color: \"red\" }}>{error.toString()}</p> :\n          <p>{ loading ? \"Loading…\" : <Plural n={places.length} singular=\"Total Place\" /> }</p>\n        }\n        <label>\n          <input type=\"checkbox\" checked={loadOnScroll} onChange={e => setLoadOnScroll(e.target.checked)} />\n          Load on pan/zoom\n        </label>\n        <button onClick={loadData}>Load now</button>\n\n        <TierControls\n          label=\"100k+\"\n          places={placesT1}\n          connectors={connectorsT1}\n          showNodes={showT1Nodes}\n          setShowNodes={setShowT1Nodes}\n          showVertices={showT1Vertices}\n          setShowVertices={setShowT1Vertices}\n          maxVertexLength={maxT1VertexLength}\n          setMaxVertexLength={setMaxT1VertexLength}\n        />\n\n        <TierControls\n          label=\"50k - 100k\"\n          places={placesT2}\n          connectors={connectorsT2}\n          showNodes={showT2Nodes}\n          setShowNodes={setShowT2Nodes}\n          showVertices={showT2Vertices}\n          setShowVertices={setShowT2Vertices}\n          maxVertexLength={maxT2VertexLength}\n          setMaxVertexLength={setMaxT2VertexLength}\n        />\n\n        <TierControls\n          label=\"10k - 50k\"\n          places={placesT3}\n          connectors={connectorsT3}\n          showNodes={showT3Nodes}\n          setShowNodes={setShowT3Nodes}\n          showVertices={showT3Vertices}\n          setShowVertices={setShowT3Vertices}\n          maxVertexLength={maxT3VertexLength}\n          setMaxVertexLength={setMaxT3VertexLength}\n        />\n\n        <TierControls\n          label=\"5k - 10k\"\n          places={placesT4}\n          connectors={connectorsT4}\n          showNodes={showT4Nodes}\n          setShowNodes={setShowT4Nodes}\n          showVertices={showT4Vertices}\n          setShowVertices={setShowT4Vertices}\n          maxVertexLength={maxT4VertexLength}\n          setMaxVertexLength={setMaxT4VertexLength}\n        />\n\n        <h2>Options</h2>\n        <label>\n          Narrow Angle Limit (degrees)\n          <input type=\"number\" min={0} max={180} value={narrowAngleLimit} onChange={e => setNarrowAngleLimit(e.target.valueAsNumber)} />\n        </label>\n        <h2>Download</h2>\n        <button onClick={handleDownload}>kml</button>\n      </div>\n      {/* eslint-disable-next-line */}\n      <Map style=\"mapbox://styles/mapbox/streets-v9\"\n        containerStyle={{\n          height: '100vh',\n          width: '100vw'\n        }}\n        onSourceData={handleSourceData}\n        center={initialCentre}\n        zoom={initialZoom}\n      >\n        <Tier places={showT4Nodes ? placesT4 : []} connectors={connectorsT4} tier={4} />\n        <Tier places={showT3Nodes ? placesT3 : []} connectors={connectorsT3} tier={3} />\n        <Tier places={showT2Nodes ? placesT2 : []} connectors={connectorsT2} tier={2} />\n        <Tier places={showT1Nodes ? placesT1 : []} connectors={connectorsT1} tier={1} />\n        <ZoomControl />\n        <ScaleControl />\n      </Map>\n    </div>\n  );\n}\n\nexport default App;\n\n/**\n *\n * @param {Function} callback\n * @param {number} timeout\n * @param {any[]} timeout\n */\nfunction useDebouncedCallback (callback, timeout = 1000) {\n  let readyRef = useRef(true);\n\n  return useCallback((...args) => {\n    if (readyRef.current) {\n      callback(...args);\n      readyRef.current = false;\n      setTimeout(() => readyRef.current = true, timeout);\n    }\n  }, [callback, timeout]);\n}\n\n/**\n * @param {number[]} bounds\n */\nfunction fetchPlaces (bounds) {\n  const bbox = bounds.map(b => b.toFixed(3)).join(\",\")\n  const url = `https://overpass-api.de/api/interpreter?data=[out:json][bbox];(node[population];-node[place~\"^country|state$\"];);out;&bbox=${bbox}`;\n  return cachedFetch(url);\n}\n\n/*\n * Version 1 Cache\n */\n// const cache = {};\n// function cachedFetch (url) {\n//   if (!cache[url]) {\n//     cache[url] = fetch(url).then(r => r.ok ? r.json() : Promise.reject(r.text()));\n//   }\n\n//   return cache[url];\n// }\n\n/*\n * Version 2 attempts to prevent memory leaks\n */\nconst cache = [];\nconst cacheLimit = 10;\nfunction cachedFetch (url) {\n  let hit = cache.find(h => h.url === url);\n\n  if (!hit) {\n    hit = {\n      url,\n      result: fetch(url).then(r => r.ok ? r.json() : (r.status === 429 ? Promise.reject(\"Too many requests. Please wait a minute.\") : Promise.reject(\"Error fetching data\"))),\n    };\n\n    cache.unshift(hit);\n    cache.length = Math.min(cacheLimit, cache.length);\n  }\n\n  return hit.result;\n}\n\nfunction downloadFile (filename, data) {\n  const blob = new Blob([data]);\n  const url = window.URL.createObjectURL(blob);\n  const a = document.createElement(\"a\");\n  a.href = url;\n  a.download = filename;\n  document.body.append(a);\n  a.click();\n  setTimeout(() => {\n    document.body.removeChild(a);\n    window.URL.revokeObjectURL(url);\n  });\n}\n\n/**\n * @param {string} key\n */\nfunction getLocalStorageJSON (key) {\n  const saved = localStorage.getItem(key);\n\n  if (saved) {\n    try {\n      return JSON.parse(saved);\n    } catch (e) {}\n  }\n\n  return void 0;\n}","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root')\n);"],"sourceRoot":""}